<!-- START screens/plugins/pre/StartJupyterServer.vm -->
<script src="$content.getURI("/scripts/xnat/plugin/jupyterhub/jupyterhub-servers.js")"></script>

<script type="text/javascript">

    const href = window.location.href;

    jupyterHandlerForStoredSearch = function(name, eventObj, menuItem){
        console.debug('jupyterHandlerForStoredSearch');
        const storedSearchId = this.obj.SS_ID;
        const storedSearchLabel = this.obj.label;

        XNAT.plugin.jupyterhub.servers.startServerForStoredSearch(window.username, storedSearchId, "xdat:stored_search",
                storedSearchId, storedSearchLabel, XNAT.plugin.jupyterhub.servers.generateEventTrackingId());
    };

    jupyterHandlerForDataSearch = function(name, eventObj, menuItem){
        console.debug('jupyterHandlerForDataSearch');
        const storedSearchId = this.obj.ID.replace("d.", "@");
        const storedSearchLabel = this.obj.label;

        XNAT.plugin.jupyterhub.servers.startServerForStoredSearch(window.username, storedSearchId, "xdat:stored_search",
                storedSearchId, storedSearchLabel, XNAT.plugin.jupyterhub.servers.generateEventTrackingId());
    };

    jupyterHandlerForProjectBundleSearch = function(name, eventObj, menuItem){
        console.debug('jupyterHandlerForProjectBundleSearch');

        let storedSearchLabel;

        let storedSearchId;
        if (this.obj.ID.startsWith("@")) {
            // Default project bundle
            storedSearchId = XNAT.data.context.ID + this.obj.ID;
            storedSearchLabel = `${XNAT.data.context.ID}: ${this.obj.label}`;
        } else {
            // Project level stored search
            storedSearchId = this.obj.ID;
            storedSearchLabel = this.obj.label;
        }

        XNAT.plugin.jupyterhub.servers.startServerForStoredSearch(window.username, storedSearchId, "xdat:stored_search",
                storedSearchId, storedSearchLabel, XNAT.plugin.jupyterhub.servers.generateEventTrackingId());
    };

    let jupyterHandler;

    if (href.includes('Search.vm/node/ss')) { // Are we on the Stored Search view?
        jupyterHandler = jupyterHandlerForStoredSearch;
    } else if (href.includes('Search.vm/node/d')) { // Are we on the Data view?
        jupyterHandler = jupyterHandlerForDataSearch;
    } else if (XNAT.data.context.xsiType === "xnat:projectData") {
        jupyterHandler = jupyterHandlerForProjectBundleSearch;
    }

    if (jupyterHandler) {
        let jupyterMenuOption = {
            'label' : 'Start Jupyter Server',
            'handler': jupyterHandler
        }

        addSearchMenuOption(jupyterMenuOption)
    }
</script>
<!-- END screens/plugins/pre/StartJupyterServer.vm -->